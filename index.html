<!doctype html>
<html>
	<title>enchant.fish</title>
	<head>
		<script type="text/javascript" src="enchant/enchant.js"></script>
		<script type="text/javascript" src="underscore/underscore.js"></script>
		<!-- 部品クラス -->
		<script type="text/javascript" src="_common.js"></script>
		<script type="text/javascript" src="ground.js"></script>
		<script type="text/javascript" src="tichan.js"></script>
		<script type="text/javascript" src="milk.js"></script>
		<script type="text/javascript" src="milk_manager.js"></script>
		<script type="text/javascript" src="background.js"></script>
		<script type="text/javascript" src="fish.js"></script>
		<script type="text/javascript" src="start.js"></script>
		<script type="text/javascript" src="score.js"></script>
		<script type="text/javascript" src="gameover.js"></script>
		<script type="text/javascript" src="meter.js"></script>
		<!-- シーン -->
		<script type="text/javascript" src="scenes/game.js"></script>
	</script>
</head>
<body style="margin:0; padding: 0; background-color: #888;">
<!--
基本
http://www.atmarkit.co.jp/ait/articles/1304/01/news034_3.html
点滅
http://www.openspc2.org/reibun/enchant.js/v0.4.3/label/0004/index.html
背景スクロール
http://www.atmarkit.co.jp/ait/articles/1306/25/news026_2.html
-->
<script type="text/javascript">
	// -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- //
	// 処理開始
	// -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- //
	enchant(); // initialize

	/*
	http://jsdo.it/kitao/enchantjs-pixelart
	CanvasLayer初期化後にcanvasのコンテキストを操作する
	拡大時の処理をNearest Neighbor方式に切り替え
	(※Chrome, FireFox のみ)
	*/
	var initCanvas = CanvasLayer.prototype.initialize;
	CanvasLayer.prototype.initialize = function () {
		initCanvas.call(this);
		this.context.imageSmoothingEnabled = false;
		this.context.webkitImageSmoothingEnabled = false;
		this.context.mozImageSmoothingEnabled = false;
	};
    
	// 基本設定
	var game = new Core(320, 240); // game stage // 画面サイズ
	game.scale = 1; // 拡大率
	game.fps = FPS; // 20fps→15

	// リソース準備
	PreloadImages(game, [Background, Fish, Ground, Milk, Tichan, Start, Score, Gameover, Meter]);

	// タイトルシーン
	var createTitleScene = function(){
		var scene = GenerateScene();

		// タイトル背景画像
		var back = new Sprite(320, 240);
		back.image = game.assets['img/title.png'];
		scene.groups['bg'].addChild(back);

		// ラベル
		//var label = new Label('Welcome the enchant.fish world!');
		//scene.addChild(label);

		// スタート画像
		var start = new Sprite(236, 48);
		start.x = (320 - 236) / 2;
		start.y = (240 - 48) / 2;
		start.textAlign = 'center';
		start.image = game.assets['img/start.png'];
		scene.groups['ch'].addChild(start);

		// スタート画像は点滅させる
		start.addEventListener(Event.ENTER_FRAME, function(){
			start.opacity = (new Date()).getMilliseconds() > 500 ? 1 : 0;
		});

		// タッチイベント
		scene.addEventListener(Event.TOUCH_START, function(e){
			// ゲームシーンに切り替え
			game.replaceScene(createGameScene());
		});

		// 作成されたシーンを返す
		return scene;
	};

	// ゲームシーン
	var createGameScene = function () {
		var scene = GenerateScene();

		// ゲームループ背景画像
		var bg1 = new Background(scene.groups[0], 'img/bg-back-z0.gif', 160, 240, 0.5);
		var bg2 = new Background(scene.groups[1], 'img/bg-front-z1.gif', 160, 240, 1);
		scene.addEventListener(Event.ENTER_FRAME, function () {
			bg1.frame();
			bg2.frame();
		});

		// BGM
		var sound = game.assets['sounds/looperman-t-0404662-0151402-scottb55-raise-hell-and-ptl.mp3'];
		//var sound = game.assets['sounds/looperman-l-1048767-0068538-buffalonugaluss-drumstep-drums.wav'];
		scene.addEventListener(Event.ENTER_FRAME, function () {
			sound.play();
		});

		// -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- //
		// 地面
		// -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- //
		// 地面リスト
		var grounds = [];
		for (var i = 0; i < 11; i++) {
			var ground = new Ground(scene, i * 32);
			grounds.push(ground);
			//scene.addChild(ground.sprite);
		}

		// メインキャラ
		var fish = new Fish(scene); 	// さかなくんさん
		window.g_fish = fish; 		// グローバルアクセス
		var tichan = new Tichan(scene); // ちーちゃん
		window.g_tichan = tichan; 	// グローバルアクセス

		// オブジェクト
		var start = new Start(scene);

		// スコア
		var score = new Score(scene);

		// 距離
		var meter = new Meter(scene);

		// 背景のフレーム処理
		var ground_counter = 0;
		var milkManager = new MilkManager(scene);
		scene.addEventListener(Event.ENTER_FRAME, function () {
			// 地面
			for (var i = 0; i < grounds.length; i++) {
				var ground = grounds[i];
				var ret = ground.frame();
				if (ret != 0) {
					// ground削除
					ground.dispose();
					grounds.splice(i, 1);
					i--;
				}
			}
			// 地面が減っていたらもう1個足す
			if (grounds.length <= 10) {
				var ground = new Ground(scene, 320);
				grounds.push(ground);
				// このタイミングでミルクの抽選を行う
				milkManager.lottery();
			}

			// 各種フレーム処理
			milkManager.frame(); // 牛乳群
			score.frame(); // スコア
			meter.frame(); // 距離

			// さかなくんが死んでたらゲームオーバー表示
			if (fish.deadFlag == 1) {
				fish.deadFlag = 2;
				//game.pushScene(window.createGameoverScene());

				// 死に演出
				window.g_gameover = new Gameover(scene);

				// タッチしたら死に演出は削除してゲームリトライ
				Retry = function (e) {
					// さかなくん復活
					fish.reset();

					// 死に演出削除
					window.g_gameover.disposeSlow();
					delete window.g_gameover;

					// コールバック削除
					scene.removeEventListener(Event.TOUCH_START, Retry);
				};
				scene.addEventListener(Event.TOUCH_START, Retry);
			}
		});
		scene.backgroundColor = 'rgb(0, 107, 247)';



		// イベント（タッチしたらゲームオーバー）
		/*
		scene.addEventListener(Event.TOUCH_START, function(e){
		// 今のシーンの上に重ねてシーンを乗せる
		game.pushScene(createGameoverScene());
		});
		*/

		// 盛り上がる地面・迫りくる壁・燃え尽きるハート・震えるビート
		return scene;
	};

	// ゲームオーバーシーン
	window.createGameoverScene = function () {
		var scene = GenerateScene();
		var label = new Label('You died');
		label.x = 0;
		label.y = 20;
		scene.addChild(label);
		scene.backgroundColor = 'rgba(0, 0, 0, 0.5)'; // 半透明な黒
		scene.addEventListener(Event.TOUCH_START, function(e){
			game.popScene();
		});
		return scene;
	};

	// -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- //
	// シーン開始
	// -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- //
	game.onload = function(){
		// 最初のシーン（タイトル）
		//game.replaceScene(createTitleScene());
		game.replaceScene(createGameScene());
	};
	game.start(); // start your game!
</script>
</body>
</html>

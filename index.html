<!doctype html>
<html>
    <title>enchant.fish</title>
    <head><script src="enchant/enchant.js"></script>
    <head><script src="underscore/underscore.js"></script>
</head>
<body style="margin:0; padding: 0; background-color: #888;">
<!--
基本
http://www.atmarkit.co.jp/ait/articles/1304/01/news034_3.html
点滅
http://www.openspc2.org/reibun/enchant.js/v0.4.3/label/0004/index.html
背景スクロール
http://www.atmarkit.co.jp/ait/articles/1306/25/news026_2.html
-->
<script>
    // -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- //
    // 地面
    // -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- //
    Ground = function(scene, x){
        // 参照
        this.scene = scene;
        
        // 位置
        this.x = x;
        this.y = 240 - 32;
        
        // 高さは 1～5
        this.height = 1 + Math.floor(Math.random() * 5);
        
        // 高さ分だけスプライトを作る
        this.sprites = [];
        for(var i = 0; i < this.height; i++){
            var sprite = new Sprite(32, 32);
            sprite.image = game.assets['img/ground32x32.gif'];
            sprite.x = this.x + 100;
            sprite.y = this.y - (i * 32);
            console.log("this.x = " + this.x + ", this.y = " + this.y);
            console.log("sprite.x = " + sprite.x + ", sprite.y = " + sprite.y);
            // シーンに追加
            scene.groups['bg'].addChild(sprite);
            // thisに追加
            this.sprites.push(sprite);
        }

        // フレーム処理。
        // 戻り値0: 通常
        // 戻り値0以外: オブジェクト削除
        this.frame = function(){
            var LOOP_SPEED = 4;
            this.x -= LOOP_SPEED;
            if(this.x <= -32){
                return 1; // 削除
            }
            // スプライト更新
            var this_x = this.x;
            _.each(this.sprites, function(sprite){
                sprite.x = this_x;
            });
            return 0; // 継続
        };
        
        // 削除
        var scene = this.scene;
        this.dispose = function(){
            _.each(this.sprites, function(sprite){
                scene.removeChild(sprite);
            });
            this.sprites = [];
        };
    };
    
    // -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- //
    // シーン作成
    // -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- //
    function GenerateScene(){
        var scene = new Scene();

        // グループ
        var bggroup = new Group(); // 背景用グループ
        scene.addChild(bggroup);
        var chgroup = new Group(); // キャラ用グループ
        scene.addChild(chgroup);

        // グループには名前でアクセスできるようにしておく
        scene.groups = {
            bg: bggroup,
            ch: chgroup
        };
        
        return scene;
    }
    
    // -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- //
    // 処理開始
    // -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- //
    enchant(); // initialize
    
    // 基本設定
    var game = new Core(320, 240); // game stage // 画面サイズ
    game.scale = 1; // 拡大率
    game.fps = 20; // 20fps
    
    // リソース準備
    game.preload('img/chara1.png'); // preload image
    game.preload('img/title.png'); // タイトル背景
    game.preload('img/game.png'); // ゲーム背景
    game.preload('img/gameloop.png'); // ゲーム背景ループ 320x50
    game.preload('img/start.png'); // START 236x48
    game.preload('img/fishkun37x24.gif'); // ふぃっしゅくん
    game.preload('img/ground32x32.gif'); // 地面
    game.preload('img/groundb32x32.gif'); // 地面（緑）
    game.preload('img/ground320x32.gif'); // 地面（長い版）

    game.onload = function(){
        // タイトルシーン
        var createTitleScene = function(){
            var scene = GenerateScene();
            
            // タイトル背景画像
            var back = new Sprite(320, 240);
            back.image = game.assets['img/title.png'];
            scene.groups['bg'].addChild(back);

            // ラベル
            //var label = new Label('Welcome the enchant.fish world!');
            //scene.addChild(label);

            // スタート画像
            var start = new Sprite(236, 48);
            start.x = (320 - 236) / 2;
            start.y = (240 - 48) / 2;
            start.textAlign = 'center';
            start.image = game.assets['img/start.png'];
            scene.groups['ch'].addChild(start);
            
            // スタート画像は点滅させる
            start.addEventListener(Event.ENTER_FRAME, function(){
               start.opacity = (new Date()).getMilliseconds() > 500 ? 1 : 0;
            });
            
            // タッチイベント
            scene.addEventListener(Event.TOUCH_START, function(e){
                // ゲームシーンに切り替え
                game.replaceScene(createGameScene());
            });

            // 作成されたシーンを返す
            return scene;
        };
        
        // ゲームシーン
        var createGameScene = function(){
            var scene = GenerateScene();
            
            // ゲーム背景画像
            //var back = new Sprite(320, 240);
            //back.image = game.assets['img/game.png'];
            //scene.addChild(back);
            
            // ラベル
            var label = new Label('Go go go!!!');
            scene.addChild(label);
            
            // ゲームループ背景画像
            var loop = new Sprite(320, 50);
            loop.image = game.assets['img/gameloop.png'];
            loop.y = 240 - 32 - 50;
            scene.groups['bg'].addChild(loop);
            var loop2 = new Sprite(320, 50);
            loop2.image = game.assets['img/gameloop.png'];
            loop2.x = 320;
            loop2.y = 240 - 32 - 50;
            scene.groups['bg'].addChild(loop2);
            
            // -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- //
            // 地面
            // -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- //
            // 地面作成
            /*
            var ground1 = new Sprite(320, 32);
            ground1.image = game.assets['img/ground320x32.gif'];
            ground1.y = 240 - 32;
            scene.addChild(ground1);
            var ground2 = new Sprite(320, 32);
            ground2.image = game.assets['img/ground320x32.gif'];
            ground2.x = 320;
            ground2.y = 240 - 32;
            scene.addChild(ground2);
            */
            // 地面リスト
            var grounds = [];
            for(var i = 0; i < 11; i++){
                var ground = new Ground(scene, i * 32);
                grounds.push(ground);
                //scene.addChild(ground.sprite);
            }

            // 背景のフレーム処理
            var ground_counter = 0;
            scene.addEventListener(Event.ENTER_FRAME, function(){
                // -- -- 背景スクロール -- -- //
                // 遠景
                var LOOP_SPEED_DIST = 1;
                loop.x -= LOOP_SPEED_DIST;
                if(loop.x <= -320){
                    loop.x = 320;
                }
                loop2.x -= LOOP_SPEED_DIST;
                if(loop2.x <= -320){
                    loop2.x = 320;
                }
                // 地面
                for(var i = 0; i < grounds.length; i++){
                    var ground = grounds[i];
                    var ret = ground.frame();
                    if(ret != 0){
                        // ground削除
                        ground.dispose();
                        grounds.splice(i, 1);
                        i--;
                    }
                }
                // 地面が減っていたらもう1個足す
                if(grounds.length <= 10){
                    var ground = new Ground(scene, 320);
                    grounds.push(ground);
                }
            });
            scene.backgroundColor = 'rgb(0, 107, 247)';
            
            // キャラ（くま）
            var bear = new Sprite(32, 32); // 1キャラのサイズ
            bear.image = game.assets['img/chara1.png'];
            bear.frame = [6, 6, 7, 7];   // select sprite frame
            bear.tl.moveBy(288, 0, 90)   // move right
                .scaleTo(-1, 1, 10)      // turn left
                .moveBy(-288, 0, 90)     // move left
                .scaleTo(1, 1, 10)       // turn right
                .loop();                 // loop it
            scene.groups['ch'].addChild(bear);

            // キャラ（さかな）
            var LIMIT_Y = 186;
            var fish = new Sprite(37, 24); // 1キャラのサイズ
            fish.y = LIMIT_Y;
            fish.image = game.assets['img/fishkun37x24.gif'];
            fish.frame = [0, 1, 2, 3, 4, 5];   // select sprite frame
            fish.tl.moveBy(288, 0, 90)   // move right
                .scaleTo(-1, 1, 10)      // turn left
                .moveBy(-288, 0, 90)     // move left
                .scaleTo(1, 1, 10)       // turn right
                .loop();                 // loop it
            scene.groups['ch'].addChild(fish);
            fish.my = 0;
            fish.jump = function(){
                // 上方向への速度を設定
                fish.my = -8;
                console.log("jump");
            };
            
            // さかなさんのフレーム処理
            fish.addEventListener(Event.ENTER_FRAME, function(e){
                // 加速度による速度計算
                fish.my += 0.9;
                if(fish.my >= 100)fish.my = 0;
                
                // 速度による位置計算
                fish.y += fish.my;
                
                // 位置制限
                if(fish.y >= LIMIT_Y)fish.y = LIMIT_Y;
            });

            // タッチしたらジャンプ
            scene.addEventListener(Event.TOUCH_START, function(e){
                fish.jump();
            });
            
            // イベント（タッチしたらゲームオーバー）
            /*
            scene.addEventListener(Event.TOUCH_START, function(e){
                // 今のシーンの上に重ねてシーンを乗せる
                game.pushScene(createGameoverScene());
            });
            */
            
            // 盛り上がる地面・迫りくる壁・燃え尽きるハート・震えるビート
            return scene;
        };
        
        // ゲームオーバーシーン
        var createGameoverScene = function(){
            var scene = GenerateScene();
            var label = new Label('You died');
            label.x = 0;
            label.y = 20;
            scene.addChild(label);
            scene.backgroundColor = 'rgba(0, 0, 0, 0.5)'; // 半透明な黒
            scene.addEventListener(Event.TOUCH_START, function(e){
                game.popScene();
            });
            return scene;
        };
        
        // 最初のシーン（タイトル）
        //game.replaceScene(createTitleScene());
        game.replaceScene(createGameScene());
    };

    game.start(); // start your game!
</script>
</body>
</html>
